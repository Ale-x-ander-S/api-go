# üöÄ –î–µ–ø–ª–æ–π —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ë–î

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ –∏ —Å—Ö–µ–º–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### 1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
make migration-status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–π
make migration-verify

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
make migration-create NAME=add_new_column
```

### 2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏**

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏
make migration-create NAME=add_user_phone

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
# migrations/YYYYMMDD_HHMMSS_add_user_phone.sql
```

**–ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏:**

```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è 2025-01-20: add_user_phone
-- –î–∞—Ç–∞: Mon Jan 20 10:30:00 MSK 2025

-- ========================================
-- UP MIGRATION (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
-- ========================================

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone_number VARCHAR(20);

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
UPDATE users SET phone_number = '–ù–µ —É–∫–∞–∑–∞–Ω' WHERE phone_number IS NULL;

-- ========================================
-- DOWN MIGRATION (–æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)
-- ========================================

-- –£–¥–∞–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
-- ALTER TABLE users DROP COLUMN IF EXISTS phone_number;

-- ========================================
-- DATA MIGRATION (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
-- ========================================

-- –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
-- –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π

-- ========================================
-- VERIFICATION (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
-- ========================================

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
SELECT COUNT(*) FROM users WHERE phone_number IS NOT NULL;
```

### 3. **–î–µ–ø–ª–æ–π —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π**

```bash
# –î–µ–ø–ª–æ–π –≤ staging —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
make deploy-staging

# –î–µ–ø–ª–æ–π –≤ production —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏  
make deploy-prod

# –ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
./deploy.sh staging
./deploy.sh prod
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π

### **–ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:**

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `IF NOT EXISTS` –∏ `IF EXISTS`**
   ```sql
   ALTER TABLE users ADD COLUMN IF NOT EXISTS new_column VARCHAR(100);
   DROP INDEX IF EXISTS idx_name;
   ```

2. **–î–µ–ª–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏–º—ã–º–∏**
   ```sql
   -- UP: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
   ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);
   
   -- DOWN: —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏  
   ALTER TABLE users DROP COLUMN IF EXISTS phone;
   ```

3. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ staging**
   - –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

4. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**
   ```bash
   # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
   docker exec -i products_postgres pg_dump -U postgres products_db > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–≥—Ä–∞—Ü–∏–π

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
make migration-status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
make migration-verify

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
./scripts/manage-migrations.sh status
```

**–í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞:**
```
–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏                                    –°—Ç–∞—Ç—É—Å         –î–∞—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è        –í—Ä–µ–º—è (–º—Å)
------------------------------------------------ --------------- -------------------- ----------
001_initial_schema.sql                           ‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–∞    2025-01-20 10:00:00    150
002_update_existing_schema.sql                   ‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–∞    2025-01-20 10:05:00    89
003_update_users_table.sql                       ‚úì –ü—Ä–∏–º–µ–Ω–µ–Ω–∞    2025-01-20 10:10:00    67
20250120_103000_add_user_phone.sql               ‚ùå –ù–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ -                    -
```

## üîÑ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

### **–û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏:**

```bash
# –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
make migration-rollback

# –ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
./scripts/manage-migrations.sh rollback
```

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏, –Ω–æ –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ –ë–î. –í–∞–º –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–ø–æ–ª–Ω–∏—Ç—å DOWN —Å–µ–∫—Ü–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏.

## üö® Troubleshooting

### **–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
   make migration-status
   
   # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
   docker exec -i products_postgres psql -U postgres -d products_db < migrations/filename.sql
   ```

2. **–û—à–∏–±–∫–∞ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏**
   ```bash
   # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ PostgreSQL
   docker-compose logs postgres
   
   # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   docker exec -it products_postgres psql -U postgres -d products_db
   ```

3. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å—Ö–µ–º—ã**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã
   docker exec -i products_postgres psql -U postgres -d products_db -c "\d+ table_name"
   
   # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ö–µ–º–æ–π
   diff <(docker exec -i products_postgres psql -U postgres -d products_db -c "\d+ table_name") expected_schema.txt
   ```

## üìà –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### **–ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π:**

1. **–°—Ö–µ–º–∞ –ë–î** - –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
2. **–î–∞–Ω–Ω—ã–µ** - –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–ò–Ω–¥–µ–∫—Å—ã** - —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä–∫–∏** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π:**

```
migrations/
‚îú‚îÄ‚îÄ 001_initial_schema.sql
‚îú‚îÄ‚îÄ 002_update_existing_schema.sql
‚îú‚îÄ‚îÄ 003_update_users_table.sql
‚îú‚îÄ‚îÄ 20250120_103000_add_user_phone.sql
‚îú‚îÄ‚îÄ 20250120_104500_add_product_tags.sql
‚îî‚îÄ‚îÄ 20250120_110000_create_audit_log.sql
```

### **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```sql
-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
-- –ú–∏–≥—Ä–∞—Ü–∏—è YYYY-MM-DD: –∫—Ä–∞—Ç–∫–æ–µ_–æ–ø–∏—Å–∞–Ω–∏–µ
-- –ê–≤—Ç–æ—Ä: –∏–º—è
-- –î–∞—Ç–∞: timestamp

-- UP MIGRATION
-- ========================================
-- –ó–¥–µ—Å—å SQL –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

-- DOWN MIGRATION  
-- ========================================
-- –ó–¥–µ—Å—å SQL –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

-- DATA MIGRATION
-- ========================================
-- –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

-- VERIFICATION
-- ========================================
-- –ó–¥–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```

## üîß –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### **CI/CD Pipeline:**

```yaml
# .github/workflows/deploy.yml
- name: Apply migrations
  run: |
    ./scripts/manage-migrations.sh apply
    
- name: Verify deployment
  run: |
    ./scripts/manage-migrations.sh verify
    make migration-status
```

### **Pre-deploy hooks:**

```bash
# scripts/pre-deploy.sh
#!/bin/bash
echo "üîç Pre-deploy –ø—Ä–æ–≤–µ—Ä–∫–∏..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
./scripts/manage-migrations.sh verify

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
./scripts/manage-migrations.sh status

# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
docker exec -i products_postgres pg_dump -U postgres products_db > backup_$(date +%Y%m%d_%H%M%S).sql

echo "‚úÖ Pre-deploy –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
```

## üìö –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞

```bash
# 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
make migration-create NAME=add_new_feature

# 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
vim migrations/*_add_new_feature.sql

# 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
make migrate

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
make migration-status

# 5. –î–µ–ø–ª–æ–π —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
make deploy-staging
make deploy-prod
```

## üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ–ø–ª–æ—è

- [ ] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ staging
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø production –ë–î
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π
- [ ] –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ staging
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ production
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å API
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

üöÄ **–ì–æ—Ç–æ–≤–æ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –¥–µ–ø–ª–æ—é!** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ë–î. 